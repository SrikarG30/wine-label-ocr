import math
import numpy as np

# --------- utilities (unchanged) ---------
def _roi_hw(blobdata):
    if "roi_shape" in blobdata and len(blobdata["roi_shape"]) == 2:
        H, W = int(blobdata["roi_shape"][0]), int(blobdata["roi_shape"][1])
        return max(1, H), max(1, W)
    if "roi_bbox" in blobdata and len(blobdata["roi_bbox"]) == 4:
        x0, y0, x1, y1 = blobdata["roi_bbox"]
        return max(1, int(y1 - y0)), max(1, int(x1 - x0))
    xs, ys, ws, hs = [], [], [], []
    for b in blobdata.get("blobs", []):
        xs.append(b.get("x", 0)); ys.append(b.get("y", 0))
        ws.append(b.get("w", 0)); hs.append(b.get("h", 0))
    H = int(max(1, max((y + h) for y, h in zip(ys or [1], hs or [1]))))
    W = int(max(1, max((x + w) for x, w in zip(xs or [1], ws or [1]))))
    return H, W

def _extract_features(blobdata):
    H, W = _roi_hw(blobdata)
    A_roi = float(H * W)
    feats = {"pos": [], "scale": [], "ratio": [], "sol": [], "ext": []}
    for b in blobdata.get("blobs", []):
        x = float(b.get("x", 0.0)); y = float(b.get("y", 0.0))
        w = float(b.get("w", 0.0)); h = float(b.get("h", 0.0))
        cx = float(b.get("cx", x + w * 0.5)); cy = float(b.get("cy", y + h * 0.5))
        area = float(b.get("area", max(1.0, w * h * 0.5)))
        ratio = float(np.clip(w / max(h, 1e-6), 1e-3, 1e3))
        extent = b.get("extent", area / max(w * h, 1e-6))
        solidity = b.get("solidity", 1.0)
        feats["pos"].append([cx / W, cy / H])
        feats["scale"].append(math.sqrt(max(area, 1.0)) / math.sqrt(A_roi))
        feats["ratio"].append(ratio)
        feats["sol"].append(float(np.clip(solidity, 0.0, 1.0)))
        feats["ext"].append(float(np.clip(extent,   0.0, 1.0)))
    for k in feats: feats[k] = np.asarray(feats[k], dtype=np.float32)
    return feats, (H, W)

def _pairwise_d2(A, B):
    a2 = np.sum(A*A, axis=1, keepdims=True)
    b2 = np.sum(B*B, axis=1, keepdims=True).T
    return a2 + b2 - 2.0 * (A @ B.T)

def _estimate_translation(posA, posB):
    if len(posA) == 0 or len(posB) == 0:
        return np.zeros(2, np.float32)
    d2 = _pairwise_d2(posA, posB)
    j = np.argmin(d2, axis=1)
    return np.median(posA - posB[j], axis=0).astype(np.float32)

def _build_cost_matrix(Fa, Fb, shift, weights):
    pa = Fa["pos"]; pb = Fb["pos"] + shift[None, :]
    dpos = np.sqrt(np.maximum(_pairwise_d2(pa, pb), 0.0))
    def expand(a, b): return a[:, None], b[None, :]
    sa, sb = expand(Fa["scale"], Fb["scale"])
    ra, rb = expand(Fa["ratio"], Fb["ratio"])
    sola, solb = expand(Fa["sol"], Fb["sol"])
    exta, extb = expand(Fa["ext"], Fb["ext"])
    dscale = np.abs(sa - sb)
    dratio = np.abs(np.log(ra / np.maximum(rb, 1e-8)))
    dsol   = np.abs(sola - solb)
    dext   = np.abs(exta - extb)
    w_pos, w_s, w_r, w_sol, w_ext = (
        weights.get("pos", 0.60),
        weights.get("scale", 0.15),
        weights.get("ratio", 0.10),
        weights.get("solidity", 0.075),
        weights.get("extent", 0.075),
    )
    return (w_pos * dpos +
            w_s   * dscale +
            w_r   * np.minimum(dratio, 2.0) +
            w_sol * dsol +
            w_ext * dext)

def _assign(cost, pair_threshold=0.22):
    na, nb = cost.shape
    if na == 0 or nb == 0: return []
    try:
        from scipy.optimize import linear_sum_assignment
        gated = cost.copy(); gated[gated > pair_threshold] = 1e6
        ia, ib = linear_sum_assignment(gated)
        return [(a, b, float(cost[a, b])) for a, b in zip(ia, ib) if cost[a, b] <= pair_threshold]
    except Exception:
        idx = np.argsort(cost, axis=None); used_a = np.zeros(na, bool); used_b = np.zeros(nb, bool)
        pairs = []
        for flat in idx:
            a, b = divmod(flat, nb); c = cost[a, b]
            if c > pair_threshold: break
            if not used_a[a] and not used_b[b]:
                used_a[a] = used_b[b] = True; pairs.append((a, b, float(c)))
        return pairs

def _score(nA, nB, pairs, costs, pair_threshold):
    if nA == 0 and nB == 0: return 1.0, 1.0, 0.0
    if nA == 0 or nB == 0 or len(pairs) == 0: return 0.0, 0.0, 1.0
    coverage = len(pairs) / float(max(nA, nB))
    med_cost = float(np.median(costs)) if costs else pair_threshold
    quality = max(0.0, 1.0 - (med_cost / max(pair_threshold, 1e-6)))
    score = 2 * (coverage * quality) / max(coverage + quality, 1e-6)  # harmonic-like
    return float(np.clip(score, 0.0, 1.0)), coverage, med_cost

# --------- public API with tunable thresholds ---------
def isBlobDataSimilar(record1, record2, *,
                      threshold=0.55,            # final decision threshold on [0,1] score
                      pair_threshold=0.22,       # max allowed per-pair cost (gate)
                      weights=None,              # optional dict to tweak component weights
                      return_details=False):
    """
    Compare record1['BlobData'] and record2['BlobData'].

    threshold:      decide 'similar' if similarity_score >= threshold
    pair_threshold: gate for counting a blob pair as a match (lower = stricter)
    weights:        e.g. {'pos':0.6,'scale':0.15,'ratio':0.1,'solidity':0.075,'extent':0.075}
    """
    weights = weights or {}
    B1 = (record1 or {}).get("BlobData", {}) or {}
    B2 = (record2 or {}).get("BlobData", {}) or {}
    F1, _ = _extract_features(B1)
    F2, _ = _extract_features(B2)
    n1, n2 = len(F1["pos"]), len(F2["pos"])
    if n1 == 0 or n2 == 0:
        details = {'score': 0.0, 'coverage': 0.0, 'median_pair_cost': 1.0,
                   'matched_pairs': 0, 'n1': n1, 'n2': n2,
                   'pair_threshold': pair_threshold, 'decision_threshold': threshold}
        return (False, details) if return_details else False

    shift = _estimate_translation(F1["pos"], F2["pos"])
    cost = _build_cost_matrix(F1, F2, shift, weights)
    pairs = _assign(cost, pair_threshold=pair_threshold)
    costs = [c for *_, c in pairs]
    score, coverage, med_cost = _score(n1, n2, pairs, costs, pair_threshold)
    similar = score >= threshold
    details = {
        'score': score,
        'coverage': coverage,
        'median_pair_cost': med_cost,
        'matched_pairs': len(pairs),
        'n1': n1, 'n2': n2,
        'pair_threshold': pair_threshold,
        'decision_threshold': threshold
    }
    return (similar, details) if return_details else similar




# --- paste your two dicts exactly as you provided ---
blobdata1 = {"image": "Wine_13.png", "timestamp": 1759027811.7756674, "roi_bbox": [0, 0, 602, 890], "roi_shape": [890, 602], "alignment_angle": 5.0, "mask_info": {"method": "image_as_mask", "foreground_ratio": 0.15794355892343873, "note": "Binary from prefiltered image"}, "blob_count": 76, "blob_fingerprint": "de20bc00db7971b6", "blobs": [{"x": 92, "y": 4, "w": 408, "h": 189, "cx": 316.51033099297894, "cy": 95.49568706118355, "area": 4985.0, "aspect_ratio": 2.1587301587301586, "solidity": 0.07342111464592907, "extent": 0.06464622886191514}, {"x": 102, "y": 24, "w": 386, "h": 150, "cx": 295.06698979960936, "cy": 96.00050640237286, "area": 13823.0, "aspect_ratio": 2.5733333333333333, "solidity": 0.27756470753599327, "extent": 0.2387392055267703}, {"x": 300, "y": 65, "w": 155, "h": 52, "cx": 377.0583869371598, "cy": 92.262246412667, "area": 4042.0, "aspect_ratio": 2.980769230769231, "solidity": 0.6183737474183432, "extent": 0.5014888337468982}, {"x": 137, "y": 77, "w": 156, "h": 55, "cx": 211.77247122214058, "cy": 102.71491550330639, "area": 4083.0, "aspect_ratio": 2.8363636363636364, "solidity": 0.62723711498579, "extent": 0.47587412587412586}, {"x": 0, "y": 108, "w": 590, "h": 237, "cx": 268.9888588426176, "cy": 302.1161709031909, "area": 9245.0, "aspect_ratio": 2.4894514767932487, "solidity": 0.09858283837532923, "extent": 0.06611599799756848}, {"x": 565, "y": 145, "w": 14, "h": 53, "cx": 569.9298245614035, "cy": 170.35672514619884, "area": 342.0, "aspect_ratio": 0.2641509433962264, "solidity": 0.644674835061263, "extent": 0.4609164420485175}, {"x": 564, "y": 203, "w": 4, "h": 28, "cx": 565.71875, "cy": 216.078125, "area": 64.0, "aspect_ratio": 0.14285714285714285, "solidity": 1.1130434782608696, "extent": 0.5714285714285714}, {"x": 2, "y": 328, "w": 588, "h": 75, "cx": 354.628544600939, "cy": 344.16920187793426, "area": 5325.0, "aspect_ratio": 7.84, "solidity": 0.15104026322134134, "extent": 0.12074829931972789}, {"x": 547, "y": 375, "w": 9, "h": 9, "cx": 550.90625, "cy": 378.75, "area": 64.0, "aspect_ratio": 1.0, "solidity": 1.1851851851851851, "extent": 0.7901234567901234}, {"x": 539, "y": 386, "w": 45, "h": 48, "cx": 556.0659203980099, "cy": 411.1256218905473, "area": 804.0, "aspect_ratio": 0.9375, "solidity": 0.5045497332914967, "extent": 0.37222222222222223}, {"x": 540, "y": 386, "w": 50, "h": 92, "cx": 568.0807511737089, "cy": 441.3474178403756, "area": 1065.0, "aspect_ratio": 0.5434782608695652, "solidity": 0.32608695652173914, "extent": 0.23152173913043478}, {"x": 118, "y": 404, "w": 54, "h": 55, "cx": 144.23049894588897, "cy": 428.17638791286015, "area": 1423.0, "aspect_ratio": 0.9818181818181818, "solidity": 0.7194135490394338, "extent": 0.4791245791245791}, {"x": 0, "y": 407, "w": 26, "h": 61, "cx": 8.357357357357357, "cy": 435.2942942942943, "area": 333.0, "aspect_ratio": 0.4262295081967213, "solidity": 0.3194244604316547, "extent": 0.20996216897856243}, {"x": 424, "y": 406, "w": 36, "h": 45, "cx": 440.5223463687151, "cy": 428.3072625698324, "area": 716.0, "aspect_ratio": 0.8, "solidity": 0.5783521809369951, "extent": 0.4419753086419753}, {"x": 465, "y": 406, "w": 23, "h": 43, "cx": 473.81337480559876, "cy": 427.02799377916017, "area": 643.0, "aspect_ratio": 0.5348837209302325, "solidity": 0.7613972764949675, "extent": 0.6501516683518705}, {"x": 350, "y": 409, "w": 29, "h": 44, "cx": 362.07474226804123, "cy": 430.8041237113402, "area": 776.0, "aspect_ratio": 0.6590909090909091, "solidity": 0.7155371138773629, "extent": 0.6081504702194357}, {"x": 381, "y": 408, "w": 39, "h": 44, "cx": 401.2108843537415, "cy": 429.13151927437644, "area": 882.0, "aspect_ratio": 0.8863636363636364, "solidity": 0.5872170439414115, "extent": 0.513986013986014}, {"x": 305, "y": 410, "w": 38, "h": 45, "cx": 323.6674082313682, "cy": 431.93437152391544, "area": 899.0, "aspect_ratio": 0.8444444444444444, "solidity": 0.5811247575953459, "extent": 0.5257309941520468}, {"x": 212, "y": 413, "w": 44, "h": 45, "cx": 233.38311688311688, "cy": 434.65367965367966, "area": 924.0, "aspect_ratio": 0.9777777777777777, "solidity": 0.6153846153846154, "extent": 0.4666666666666667}, {"x": 261, "y": 413, "w": 38, "h": 43, "cx": 277.9760087241003, "cy": 433.77753544165756, "area": 917.0, "aspect_ratio": 0.8837209302325582, "solidity": 0.6918144096567334, "extent": 0.5611995104039168}, {"x": 167, "y": 415, "w": 40, "h": 44, "cx": 186.81184668989548, "cy": 436.11265969802554, "area": 861.0, "aspect_ratio": 0.9090909090909091, "solidity": 0.6268656716417911, "extent": 0.48920454545454545}, {"x": 548, "y": 434, "w": 28, "h": 20, "cx": 563.7210884353741, "cy": 441.421768707483, "area": 147.0, "aspect_ratio": 1.4, "solidity": 0.4523076923076923, "extent": 0.2625}, {"x": 17, "y": 441, "w": 9, "h": 10, "cx": 22.13953488372093, "cy": 447.0, "area": 43.0, "aspect_ratio": 0.9, "solidity": 0.86, "extent": 0.4777777777777778}, {"x": 10, "y": 465, "w": 19, "h": 12, "cx": 20.017241379310345, "cy": 470.75, "area": 116.0, "aspect_ratio": 1.5833333333333333, "solidity": 0.7204968944099379, "extent": 0.5087719298245614}, {"x": 565, "y": 469, "w": 25, "h": 50, "cx": 579.4119718309859, "cy": 495.71830985915494, "area": 284.0, "aspect_ratio": 0.5, "solidity": 0.5333333333333333, "extent": 0.2272}, {"x": 540, "y": 481, "w": 49, "h": 106, "cx": 556.3992560446374, "cy": 543.3552386856788, "area": 1613.0, "aspect_ratio": 0.46226415094339623, "solidity": 0.4547504933746828, "extent": 0.310550635348479}, {"x": 9, "y": 486, "w": 21, "h": 16, "cx": 18.387096774193548, "cy": 493.5752688172043, "area": 186.0, "aspect_ratio": 1.3125, "solidity": 0.7607361963190185, "extent": 0.5535714285714286}, {"x": 361, "y": 502, "w": 87, "h": 47, "cx": 402.81927155371136, "cy": 527.7611802674044, "area": 2169.0, "aspect_ratio": 1.851063829787234, "solidity": 0.6587699316628701, "extent": 0.5304475421863536}, {"x": 159, "y": 508, "w": 188, "h": 53, "cx": 247.2997863755044, "cy": 534.5805839069546, "area": 4213.0, "aspect_ratio": 3.547169811320755, "solidity": 0.5845300034686091, "extent": 0.42282215977519066}, {"x": 576, "y": 512, "w": 14, "h": 8, "cx": 583.5454545454545, "cy": 514.4772727272727, "area": 44.0, "aspect_ratio": 1.75, "solidity": 0.7213114754098361, "extent": 0.39285714285714285}, {"x": 8, "y": 516, "w": 23, "h": 56, "cx": 16.960743801652892, "cy": 537.0661157024794, "area": 484.0, "aspect_ratio": 0.4107142857142857, "solidity": 0.5856019358741682, "extent": 0.37577639751552794}, {"x": 35, "y": 524, "w": 7, "h": 19, "cx": 38.38297872340426, "cy": 531.2446808510638, "area": 94.0, "aspect_ratio": 0.3684210526315789, "solidity": 1.0930232558139534, "extent": 0.706766917293233}, {"x": 20, "y": 554, "w": 8, "h": 10, "cx": 23.444444444444443, "cy": 558.2666666666667, "area": 45.0, "aspect_ratio": 0.8, "solidity": 0.9574468085106383, "extent": 0.5625}, {"x": 441, "y": 557, "w": 28, "h": 7, "cx": 455.584, "cy": 559.912, "area": 125.0, "aspect_ratio": 4.0, "solidity": 1.0080645161290323, "extent": 0.6377551020408163}, {"x": 361, "y": 559, "w": 57, "h": 9, "cx": 391.2063492063492, "cy": 563.1349206349206, "area": 252.0, "aspect_ratio": 6.333333333333333, "solidity": 0.9692307692307692, "extent": 0.49122807017543857}, {"x": 328, "y": 562, "w": 30, "h": 7, "cx": 342.95714285714286, "cy": 564.9857142857143, "area": 140.0, "aspect_ratio": 4.285714285714286, "solidity": 1.0526315789473684, "extent": 0.6666666666666666}, {"x": 15, "y": 565, "w": 42, "h": 113, "cx": 35.574212893553224, "cy": 611.1041979010495, "area": 1334.0, "aspect_ratio": 0.37168141592920356, "solidity": 0.4592873127904975, "extent": 0.281078803202697}, {"x": 142, "y": 565, "w": 21, "h": 6, "cx": 150.0108695652174, "cy": 567.2065217391304, "area": 92.0, "aspect_ratio": 3.5, "solidity": 1.15, "extent": 0.7301587301587301}, {"x": 162, "y": 565, "w": 21, "h": 7, "cx": 172.289156626506, "cy": 567.9036144578313, "area": 83.0, "aspect_ratio": 3.0, "solidity": 1.0375, "extent": 0.564625850340136}, {"x": 187, "y": 565, "w": 28, "h": 7, "cx": 199.55752212389382, "cy": 567.9203539823009, "area": 113.0, "aspect_ratio": 4.0, "solidity": 1.018018018018018, "extent": 0.576530612244898}, {"x": 214, "y": 565, "w": 29, "h": 7, "cx": 228.66949152542372, "cy": 568.0084745762712, "area": 118.0, "aspect_ratio": 4.142857142857143, "solidity": 1.0216450216450217, "extent": 0.5812807881773399}, {"x": 251, "y": 564, "w": 23, "h": 7, "cx": 260.1666666666667, "cy": 567.1547619047619, "area": 84.0, "aspect_ratio": 3.2857142857142856, "solidity": 0.9081081081081082, "extent": 0.5217391304347826}, {"x": 290, "y": 564, "w": 21, "h": 6, "cx": 300.6326530612245, "cy": 566.5204081632653, "area": 98.0, "aspect_ratio": 3.5, "solidity": 1.0710382513661203, "extent": 0.7777777777777778}, {"x": 47, "y": 570, "w": 32, "h": 10, "cx": 61.21511627906977, "cy": 573.1802325581396, "area": 172.0, "aspect_ratio": 3.2, "solidity": 0.8888888888888888, "extent": 0.5375}, {"x": 243, "y": 583, "w": 19, "h": 34, "cx": 252.43121693121694, "cy": 599.494708994709, "area": 378.0, "aspect_ratio": 0.5588235294117647, "solidity": 0.7448275862068966, "extent": 0.5851393188854489}, {"x": 349, "y": 587, "w": 19, "h": 26, "cx": 357.57716049382714, "cy": 599.9228395061729, "area": 324.0, "aspect_ratio": 0.7307692307692307, "solidity": 0.7732696897374701, "extent": 0.6558704453441295}, {"x": 291, "y": 589, "w": 8, "h": 26, "cx": 294.625, "cy": 601.83125, "area": 160.0, "aspect_ratio": 0.3076923076923077, "solidity": 1.0389610389610389, "extent": 0.7692307692307693}, {"x": 302, "y": 589, "w": 21, "h": 26, "cx": 310.14044943820227, "cy": 601.4410112359551, "area": 356.0, "aspect_ratio": 0.8076923076923077, "solidity": 0.8790123456790123, "extent": 0.652014652014652}, {"x": 324, "y": 589, "w": 22, "h": 25, "cx": 334.8727272727273, "cy": 601.84, "area": 275.0, "aspect_ratio": 0.88, "solidity": 0.8088235294117647, "extent": 0.5}, {"x": 267, "y": 590, "w": 21, "h": 25, "cx": 276.7771883289125, "cy": 601.7188328912467, "area": 377.0, "aspect_ratio": 0.84, "solidity": 0.7953586497890295, "extent": 0.7180952380952381}, {"x": 538, "y": 602, "w": 42, "h": 67, "cx": 556.7786438035854, "cy": 632.8409976617303, "area": 1283.0, "aspect_ratio": 0.6268656716417911, "solidity": 0.5854437599817477, "extent": 0.4559346126510306}, {"x": 59, "y": 613, "w": 9, "h": 19, "cx": 62.608695652173914, "cy": 622.8260869565217, "area": 69.0, "aspect_ratio": 0.47368421052631576, "solidity": 0.7885714285714286, "extent": 0.40350877192982454}, {"x": 581, "y": 640, "w": 8, "h": 17, "cx": 585.4146341463414, "cy": 648.7073170731708, "area": 41.0, "aspect_ratio": 0.47058823529411764, "solidity": 0.7387387387387387, "extent": 0.3014705882352941}, {"x": 21, "y": 645, "w": 9, "h": 21, "cx": 24.721739130434784, "cy": 653.3391304347826, "area": 115.0, "aspect_ratio": 0.42857142857142855, "solidity": 0.9583333333333334, "extent": 0.6084656084656085}, {"x": 311, "y": 649, "w": 23, "h": 33, "cx": 321.9281045751634, "cy": 664.9564270152506, "area": 459.0, "aspect_ratio": 0.696969696969697, "solidity": 0.8052631578947368, "extent": 0.6047430830039525}, {"x": 342, "y": 649, "w": 24, "h": 32, "cx": 353.2230919765166, "cy": 663.9549902152642, "area": 511.0, "aspect_ratio": 0.75, "solidity": 0.880275624461671, "extent": 0.6653645833333334}, {"x": 249, "y": 650, "w": 22, "h": 33, "cx": 258.9628008752735, "cy": 666.7833698030635, "area": 457.0, "aspect_ratio": 0.6666666666666666, "solidity": 0.7455138662316476, "extent": 0.6294765840220385}, {"x": 279, "y": 650, "w": 24, "h": 33, "cx": 290.32278481012656, "cy": 665.6835443037975, "area": 474.0, "aspect_ratio": 0.7272727272727273, "solidity": 0.8006756756756757, "extent": 0.5984848484848485}, {"x": 62, "y": 656, "w": 8, "h": 10, "cx": 64.58536585365853, "cy": 660.170731707317, "area": 41.0, "aspect_ratio": 0.8, "solidity": 1.0, "extent": 0.5125}, {"x": 564, "y": 657, "w": 12, "h": 8, "cx": 569.2142857142857, "cy": 660.3571428571429, "area": 42.0, "aspect_ratio": 1.5, "solidity": 0.9333333333333333, "extent": 0.4375}, {"x": 539, "y": 660, "w": 50, "h": 29, "cx": 563.1363636363636, "cy": 675.1688311688312, "area": 308.0, "aspect_ratio": 1.7241379310344827, "solidity": 0.4316748423265592, "extent": 0.21241379310344827}, {"x": 30, "y": 674, "w": 8, "h": 12, "cx": 33.91803278688525, "cy": 679.1311475409836, "area": 61.0, "aspect_ratio": 0.6666666666666666, "solidity": 1.079646017699115, "extent": 0.6354166666666666}, {"x": 363, "y": 680, "w": 107, "h": 14, "cx": 421.26728971962615, "cy": 686.5588785046729, "area": 535.0, "aspect_ratio": 7.642857142857143, "solidity": 0.9587813620071685, "extent": 0.35714285714285715}, {"x": 45, "y": 683, "w": 6, "h": 16, "cx": 47.75609756097561, "cy": 691.3170731707318, "area": 41.0, "aspect_ratio": 0.375, "solidity": 0.845360824742268, "extent": 0.4270833333333333}, {"x": 154, "y": 688, "w": 15, "h": 6, "cx": 160.24285714285713, "cy": 690.3714285714286, "area": 70.0, "aspect_ratio": 2.5, "solidity": 1.1965811965811965, "extent": 0.7777777777777778}, {"x": 291, "y": 689, "w": 24, "h": 7, "cx": 300.0375, "cy": 691.75, "area": 80.0, "aspect_ratio": 3.4285714285714284, "solidity": 0.9195402298850575, "extent": 0.47619047619047616}, {"x": 330, "y": 688, "w": 27, "h": 7, "cx": 341.6640625, "cy": 690.8671875, "area": 128.0, "aspect_ratio": 3.857142857142857, "solidity": 1.080168776371308, "extent": 0.6772486772486772}, {"x": 209, "y": 690, "w": 17, "h": 6, "cx": 217.0483870967742, "cy": 692.5483870967741, "area": 62.0, "aspect_ratio": 2.8333333333333335, "solidity": 1.0782608695652174, "extent": 0.6078431372549019}, {"x": 234, "y": 690, "w": 17, "h": 7, "cx": 242.22058823529412, "cy": 692.6470588235294, "area": 68.0, "aspect_ratio": 2.4285714285714284, "solidity": 1.0625, "extent": 0.5714285714285714}, {"x": 257, "y": 690, "w": 23, "h": 6, "cx": 267.8235294117647, "cy": 692.5764705882353, "area": 85.0, "aspect_ratio": 3.8333333333333335, "solidity": 1.103896103896104, "extent": 0.6159420289855072}, {"x": 58, "y": 695, "w": 6, "h": 9, "cx": 60.26190476190476, "cy": 698.7142857142857, "area": 42.0, "aspect_ratio": 0.6666666666666666, "solidity": 1.2727272727272727, "extent": 0.7777777777777778}, {"x": 582, "y": 695, "w": 7, "h": 15, "cx": 585.7173913043479, "cy": 699.8695652173913, "area": 46.0, "aspect_ratio": 0.4666666666666667, "solidity": 0.7479674796747967, "extent": 0.4380952380952381}, {"x": 540, "y": 704, "w": 41, "h": 24, "cx": 558.5756385068762, "cy": 715.0943025540275, "area": 509.0, "aspect_ratio": 1.7083333333333333, "solidity": 0.7568773234200743, "extent": 0.5172764227642277}, {"x": 26, "y": 715, "w": 12, "h": 11, "cx": 32.62903225806452, "cy": 720.9193548387096, "area": 62.0, "aspect_ratio": 1.0909090909090908, "solidity": 0.8435374149659864, "extent": 0.4696969696969697}, {"x": 26, "y": 726, "w": 564, "h": 70, "cx": 310.94440647072224, "cy": 772.6686033264981, "area": 8778.0, "aspect_ratio": 8.057142857142857, "solidity": 0.30700895355344154, "extent": 0.22234042553191488}, {"x": 29, "y": 774, "w": 561, "h": 95, "cx": 392.69615384615383, "cy": 814.2107142857143, "area": 3640.0, "aspect_ratio": 5.905263157894737, "solidity": 0.11672839803100998, "extent": 0.06829908997091659}], "wine_id": "de20bc00db7971b6", "is_new_wine": True, "similar_wine": None}  # <== your first big JSON blob (the one with is_new_wine: true)
blobdata2 = {"image": "Wine_13.png", "timestamp": 1759027811.7756674, "roi_bbox": [0, 0, 602, 890], "roi_shape": [890, 602], "alignment_angle": 5.0, "mask_info": {"method": "image_as_mask", "foreground_ratio": 0.15794355892343873, "note": "Binary from prefiltered image"}, "blob_count": 76, "blob_fingerprint": "de20bc00db7971b6", "blobs": [{"x": 92, "y": 4, "w": 408, "h": 189, "cx": 316.51033099297894, "cy": 95.49568706118355, "area": 4985.0, "aspect_ratio": 2.1587301587301586, "solidity": 0.07342111464592907, "extent": 0.06464622886191514}, {"x": 102, "y": 24, "w": 386, "h": 150, "cx": 295.06698979960936, "cy": 96.00050640237286, "area": 13823.0, "aspect_ratio": 2.5733333333333333, "solidity": 0.27756470753599327, "extent": 0.2387392055267703}, {"x": 300, "y": 65, "w": 155, "h": 52, "cx": 377.0583869371598, "cy": 92.262246412667, "area": 4042.0, "aspect_ratio": 2.980769230769231, "solidity": 0.6183737474183432, "extent": 0.5014888337468982}, {"x": 137, "y": 77, "w": 156, "h": 55, "cx": 211.77247122214058, "cy": 102.71491550330639, "area": 4083.0, "aspect_ratio": 2.8363636363636364, "solidity": 0.62723711498579, "extent": 0.47587412587412586}, {"x": 0, "y": 108, "w": 590, "h": 237, "cx": 268.9888588426176, "cy": 302.1161709031909, "area": 9245.0, "aspect_ratio": 2.4894514767932487, "solidity": 0.09858283837532923, "extent": 0.06611599799756848}, {"x": 565, "y": 145, "w": 14, "h": 53, "cx": 569.9298245614035, "cy": 170.35672514619884, "area": 342.0, "aspect_ratio": 0.2641509433962264, "solidity": 0.644674835061263, "extent": 0.4609164420485175}, {"x": 564, "y": 203, "w": 4, "h": 28, "cx": 565.71875, "cy": 216.078125, "area": 64.0, "aspect_ratio": 0.14285714285714285, "solidity": 1.1130434782608696, "extent": 0.5714285714285714}, {"x": 2, "y": 328, "w": 588, "h": 75, "cx": 354.628544600939, "cy": 344.16920187793426, "area": 5325.0, "aspect_ratio": 7.84, "solidity": 0.15104026322134134, "extent": 0.12074829931972789}, {"x": 547, "y": 375, "w": 9, "h": 9, "cx": 550.90625, "cy": 378.75, "area": 64.0, "aspect_ratio": 1.0, "solidity": 1.1851851851851851, "extent": 0.7901234567901234}, {"x": 539, "y": 386, "w": 45, "h": 48, "cx": 556.0659203980099, "cy": 411.1256218905473, "area": 804.0, "aspect_ratio": 0.9375, "solidity": 0.5045497332914967, "extent": 0.37222222222222223}, {"x": 540, "y": 386, "w": 50, "h": 92, "cx": 568.0807511737089, "cy": 441.3474178403756, "area": 1065.0, "aspect_ratio": 0.5434782608695652, "solidity": 0.32608695652173914, "extent": 0.23152173913043478}, {"x": 118, "y": 404, "w": 54, "h": 55, "cx": 144.23049894588897, "cy": 428.17638791286015, "area": 1423.0, "aspect_ratio": 0.9818181818181818, "solidity": 0.7194135490394338, "extent": 0.4791245791245791}, {"x": 0, "y": 407, "w": 26, "h": 61, "cx": 8.357357357357357, "cy": 435.2942942942943, "area": 333.0, "aspect_ratio": 0.4262295081967213, "solidity": 0.3194244604316547, "extent": 0.20996216897856243}, {"x": 424, "y": 406, "w": 36, "h": 45, "cx": 440.5223463687151, "cy": 428.3072625698324, "area": 716.0, "aspect_ratio": 0.8, "solidity": 0.5783521809369951, "extent": 0.4419753086419753}, {"x": 465, "y": 406, "w": 23, "h": 43, "cx": 473.81337480559876, "cy": 427.02799377916017, "area": 643.0, "aspect_ratio": 0.5348837209302325, "solidity": 0.7613972764949675, "extent": 0.6501516683518705}, {"x": 350, "y": 409, "w": 29, "h": 44, "cx": 362.07474226804123, "cy": 430.8041237113402, "area": 776.0, "aspect_ratio": 0.6590909090909091, "solidity": 0.7155371138773629, "extent": 0.6081504702194357}, {"x": 381, "y": 408, "w": 39, "h": 44, "cx": 401.2108843537415, "cy": 429.13151927437644, "area": 882.0, "aspect_ratio": 0.8863636363636364, "solidity": 0.5872170439414115, "extent": 0.513986013986014}, {"x": 305, "y": 410, "w": 38, "h": 45, "cx": 323.6674082313682, "cy": 431.93437152391544, "area": 899.0, "aspect_ratio": 0.8444444444444444, "solidity": 0.5811247575953459, "extent": 0.5257309941520468}, {"x": 212, "y": 413, "w": 44, "h": 45, "cx": 233.38311688311688, "cy": 434.65367965367966, "area": 924.0, "aspect_ratio": 0.9777777777777777, "solidity": 0.6153846153846154, "extent": 0.4666666666666667}, {"x": 261, "y": 413, "w": 38, "h": 43, "cx": 277.9760087241003, "cy": 433.77753544165756, "area": 917.0, "aspect_ratio": 0.8837209302325582, "solidity": 0.6918144096567334, "extent": 0.5611995104039168}, {"x": 167, "y": 415, "w": 40, "h": 44, "cx": 186.81184668989548, "cy": 436.11265969802554, "area": 861.0, "aspect_ratio": 0.9090909090909091, "solidity": 0.6268656716417911, "extent": 0.48920454545454545}, {"x": 548, "y": 434, "w": 28, "h": 20, "cx": 563.7210884353741, "cy": 441.421768707483, "area": 147.0, "aspect_ratio": 1.4, "solidity": 0.4523076923076923, "extent": 0.2625}, {"x": 17, "y": 441, "w": 9, "h": 10, "cx": 22.13953488372093, "cy": 447.0, "area": 43.0, "aspect_ratio": 0.9, "solidity": 0.86, "extent": 0.4777777777777778}, {"x": 10, "y": 465, "w": 19, "h": 12, "cx": 20.017241379310345, "cy": 470.75, "area": 116.0, "aspect_ratio": 1.5833333333333333, "solidity": 0.7204968944099379, "extent": 0.5087719298245614}, {"x": 565, "y": 469, "w": 25, "h": 50, "cx": 579.4119718309859, "cy": 495.71830985915494, "area": 284.0, "aspect_ratio": 0.5, "solidity": 0.5333333333333333, "extent": 0.2272}, {"x": 540, "y": 481, "w": 49, "h": 106, "cx": 556.3992560446374, "cy": 543.3552386856788, "area": 1613.0, "aspect_ratio": 0.46226415094339623, "solidity": 0.4547504933746828, "extent": 0.310550635348479}, {"x": 9, "y": 486, "w": 21, "h": 16, "cx": 18.387096774193548, "cy": 493.5752688172043, "area": 186.0, "aspect_ratio": 1.3125, "solidity": 0.7607361963190185, "extent": 0.5535714285714286}, {"x": 361, "y": 502, "w": 87, "h": 47, "cx": 402.81927155371136, "cy": 527.7611802674044, "area": 2169.0, "aspect_ratio": 1.851063829787234, "solidity": 0.6587699316628701, "extent": 0.5304475421863536}, {"x": 159, "y": 508, "w": 188, "h": 53, "cx": 247.2997863755044, "cy": 534.5805839069546, "area": 4213.0, "aspect_ratio": 3.547169811320755, "solidity": 0.5845300034686091, "extent": 0.42282215977519066}, {"x": 576, "y": 512, "w": 14, "h": 8, "cx": 583.5454545454545, "cy": 514.4772727272727, "area": 44.0, "aspect_ratio": 1.75, "solidity": 0.7213114754098361, "extent": 0.39285714285714285}, {"x": 8, "y": 516, "w": 23, "h": 56, "cx": 16.960743801652892, "cy": 537.0661157024794, "area": 484.0, "aspect_ratio": 0.4107142857142857, "solidity": 0.5856019358741682, "extent": 0.37577639751552794}, {"x": 35, "y": 524, "w": 7, "h": 19, "cx": 38.38297872340426, "cy": 531.2446808510638, "area": 94.0, "aspect_ratio": 0.3684210526315789, "solidity": 1.0930232558139534, "extent": 0.706766917293233}, {"x": 20, "y": 554, "w": 8, "h": 10, "cx": 23.444444444444443, "cy": 558.2666666666667, "area": 45.0, "aspect_ratio": 0.8, "solidity": 0.9574468085106383, "extent": 0.5625}, {"x": 441, "y": 557, "w": 28, "h": 7, "cx": 455.584, "cy": 559.912, "area": 125.0, "aspect_ratio": 4.0, "solidity": 1.0080645161290323, "extent": 0.6377551020408163}, {"x": 361, "y": 559, "w": 57, "h": 9, "cx": 391.2063492063492, "cy": 563.1349206349206, "area": 252.0, "aspect_ratio": 6.333333333333333, "solidity": 0.9692307692307692, "extent": 0.49122807017543857}, {"x": 328, "y": 562, "w": 30, "h": 7, "cx": 342.95714285714286, "cy": 564.9857142857143, "area": 140.0, "aspect_ratio": 4.285714285714286, "solidity": 1.0526315789473684, "extent": 0.6666666666666666}, {"x": 15, "y": 565, "w": 42, "h": 113, "cx": 35.574212893553224, "cy": 611.1041979010495, "area": 1334.0, "aspect_ratio": 0.37168141592920356, "solidity": 0.4592873127904975, "extent": 0.281078803202697}, {"x": 142, "y": 565, "w": 21, "h": 6, "cx": 150.0108695652174, "cy": 567.2065217391304, "area": 92.0, "aspect_ratio": 3.5, "solidity": 1.15, "extent": 0.7301587301587301}, {"x": 162, "y": 565, "w": 21, "h": 7, "cx": 172.289156626506, "cy": 567.9036144578313, "area": 83.0, "aspect_ratio": 3.0, "solidity": 1.0375, "extent": 0.564625850340136}, {"x": 187, "y": 565, "w": 28, "h": 7, "cx": 199.55752212389382, "cy": 567.9203539823009, "area": 113.0, "aspect_ratio": 4.0, "solidity": 1.018018018018018, "extent": 0.576530612244898}, {"x": 214, "y": 565, "w": 29, "h": 7, "cx": 228.66949152542372, "cy": 568.0084745762712, "area": 118.0, "aspect_ratio": 4.142857142857143, "solidity": 1.0216450216450217, "extent": 0.5812807881773399}, {"x": 251, "y": 564, "w": 23, "h": 7, "cx": 260.1666666666667, "cy": 567.1547619047619, "area": 84.0, "aspect_ratio": 3.2857142857142856, "solidity": 0.9081081081081082, "extent": 0.5217391304347826}, {"x": 290, "y": 564, "w": 21, "h": 6, "cx": 300.6326530612245, "cy": 566.5204081632653, "area": 98.0, "aspect_ratio": 3.5, "solidity": 1.0710382513661203, "extent": 0.7777777777777778}, {"x": 47, "y": 570, "w": 32, "h": 10, "cx": 61.21511627906977, "cy": 573.1802325581396, "area": 172.0, "aspect_ratio": 3.2, "solidity": 0.8888888888888888, "extent": 0.5375}, {"x": 243, "y": 583, "w": 19, "h": 34, "cx": 252.43121693121694, "cy": 599.494708994709, "area": 378.0, "aspect_ratio": 0.5588235294117647, "solidity": 0.7448275862068966, "extent": 0.5851393188854489}, {"x": 349, "y": 587, "w": 19, "h": 26, "cx": 357.57716049382714, "cy": 599.9228395061729, "area": 324.0, "aspect_ratio": 0.7307692307692307, "solidity": 0.7732696897374701, "extent": 0.6558704453441295}, {"x": 291, "y": 589, "w": 8, "h": 26, "cx": 294.625, "cy": 601.83125, "area": 160.0, "aspect_ratio": 0.3076923076923077, "solidity": 1.0389610389610389, "extent": 0.7692307692307693}, {"x": 302, "y": 589, "w": 21, "h": 26, "cx": 310.14044943820227, "cy": 601.4410112359551, "area": 356.0, "aspect_ratio": 0.8076923076923077, "solidity": 0.8790123456790123, "extent": 0.652014652014652}, {"x": 324, "y": 589, "w": 22, "h": 25, "cx": 334.8727272727273, "cy": 601.84, "area": 275.0, "aspect_ratio": 0.88, "solidity": 0.8088235294117647, "extent": 0.5}, {"x": 267, "y": 590, "w": 21, "h": 25, "cx": 276.7771883289125, "cy": 601.7188328912467, "area": 377.0, "aspect_ratio": 0.84, "solidity": 0.7953586497890295, "extent": 0.7180952380952381}, {"x": 538, "y": 602, "w": 42, "h": 67, "cx": 556.7786438035854, "cy": 632.8409976617303, "area": 1283.0, "aspect_ratio": 0.6268656716417911, "solidity": 0.5854437599817477, "extent": 0.4559346126510306}, {"x": 59, "y": 613, "w": 9, "h": 19, "cx": 62.608695652173914, "cy": 622.8260869565217, "area": 69.0, "aspect_ratio": 0.47368421052631576, "solidity": 0.7885714285714286, "extent": 0.40350877192982454}, {"x": 581, "y": 640, "w": 8, "h": 17, "cx": 585.4146341463414, "cy": 648.7073170731708, "area": 41.0, "aspect_ratio": 0.47058823529411764, "solidity": 0.7387387387387387, "extent": 0.3014705882352941}, {"x": 21, "y": 645, "w": 9, "h": 21, "cx": 24.721739130434784, "cy": 653.3391304347826, "area": 115.0, "aspect_ratio": 0.42857142857142855, "solidity": 0.9583333333333334, "extent": 0.6084656084656085}, {"x": 311, "y": 649, "w": 23, "h": 33, "cx": 321.9281045751634, "cy": 664.9564270152506, "area": 459.0, "aspect_ratio": 0.696969696969697, "solidity": 0.8052631578947368, "extent": 0.6047430830039525}, {"x": 342, "y": 649, "w": 24, "h": 32, "cx": 353.2230919765166, "cy": 663.9549902152642, "area": 511.0, "aspect_ratio": 0.75, "solidity": 0.880275624461671, "extent": 0.6653645833333334}, {"x": 249, "y": 650, "w": 22, "h": 33, "cx": 258.9628008752735, "cy": 666.7833698030635, "area": 457.0, "aspect_ratio": 0.6666666666666666, "solidity": 0.7455138662316476, "extent": 0.6294765840220385}, {"x": 279, "y": 650, "w": 24, "h": 33, "cx": 290.32278481012656, "cy": 665.6835443037975, "area": 474.0, "aspect_ratio": 0.7272727272727273, "solidity": 0.8006756756756757, "extent": 0.5984848484848485}, {"x": 62, "y": 656, "w": 8, "h": 10, "cx": 64.58536585365853, "cy": 660.170731707317, "area": 41.0, "aspect_ratio": 0.8, "solidity": 1.0, "extent": 0.5125}, {"x": 564, "y": 657, "w": 12, "h": 8, "cx": 569.2142857142857, "cy": 660.3571428571429, "area": 42.0, "aspect_ratio": 1.5, "solidity": 0.9333333333333333, "extent": 0.4375}, {"x": 539, "y": 660, "w": 50, "h": 29, "cx": 563.1363636363636, "cy": 675.1688311688312, "area": 308.0, "aspect_ratio": 1.7241379310344827, "solidity": 0.4316748423265592, "extent": 0.21241379310344827}, {"x": 30, "y": 674, "w": 8, "h": 12, "cx": 33.91803278688525, "cy": 679.1311475409836, "area": 61.0, "aspect_ratio": 0.6666666666666666, "solidity": 1.079646017699115, "extent": 0.6354166666666666}, {"x": 363, "y": 680, "w": 107, "h": 14, "cx": 421.26728971962615, "cy": 686.5588785046729, "area": 535.0, "aspect_ratio": 7.642857142857143, "solidity": 0.9587813620071685, "extent": 0.35714285714285715}, {"x": 45, "y": 683, "w": 6, "h": 16, "cx": 47.75609756097561, "cy": 691.3170731707318, "area": 41.0, "aspect_ratio": 0.375, "solidity": 0.845360824742268, "extent": 0.4270833333333333}, {"x": 154, "y": 688, "w": 15, "h": 6, "cx": 160.24285714285713, "cy": 690.3714285714286, "area": 70.0, "aspect_ratio": 2.5, "solidity": 1.1965811965811965, "extent": 0.7777777777777778}, {"x": 291, "y": 689, "w": 24, "h": 7, "cx": 300.0375, "cy": 691.75, "area": 80.0, "aspect_ratio": 3.4285714285714284, "solidity": 0.9195402298850575, "extent": 0.47619047619047616}, {"x": 330, "y": 688, "w": 27, "h": 7, "cx": 341.6640625, "cy": 690.8671875, "area": 128.0, "aspect_ratio": 3.857142857142857, "solidity": 1.080168776371308, "extent": 0.6772486772486772}, {"x": 209, "y": 690, "w": 17, "h": 6, "cx": 217.0483870967742, "cy": 692.5483870967741, "area": 62.0, "aspect_ratio": 2.8333333333333335, "solidity": 1.0782608695652174, "extent": 0.6078431372549019}, {"x": 234, "y": 690, "w": 17, "h": 7, "cx": 242.22058823529412, "cy": 692.6470588235294, "area": 68.0, "aspect_ratio": 2.4285714285714284, "solidity": 1.0625, "extent": 0.5714285714285714}, {"x": 257, "y": 690, "w": 23, "h": 6, "cx": 267.8235294117647, "cy": 692.5764705882353, "area": 85.0, "aspect_ratio": 3.8333333333333335, "solidity": 1.103896103896104, "extent": 0.6159420289855072}, {"x": 58, "y": 695, "w": 6, "h": 9, "cx": 60.26190476190476, "cy": 698.7142857142857, "area": 42.0, "aspect_ratio": 0.6666666666666666, "solidity": 1.2727272727272727, "extent": 0.7777777777777778}, {"x": 582, "y": 695, "w": 7, "h": 15, "cx": 585.7173913043479, "cy": 699.8695652173913, "area": 46.0, "aspect_ratio": 0.4666666666666667, "solidity": 0.7479674796747967, "extent": 0.4380952380952381}, {"x": 540, "y": 704, "w": 41, "h": 24, "cx": 558.5756385068762, "cy": 715.0943025540275, "area": 509.0, "aspect_ratio": 1.7083333333333333, "solidity": 0.7568773234200743, "extent": 0.5172764227642277}, {"x": 26, "y": 715, "w": 12, "h": 11, "cx": 32.62903225806452, "cy": 720.9193548387096, "area": 62.0, "aspect_ratio": 1.0909090909090908, "solidity": 0.8435374149659864, "extent": 0.4696969696969697}, {"x": 26, "y": 726, "w": 564, "h": 70, "cx": 310.94440647072224, "cy": 772.6686033264981, "area": 8778.0, "aspect_ratio": 8.057142857142857, "solidity": 0.30700895355344154, "extent": 0.22234042553191488}, {"x": 29, "y": 774, "w": 561, "h": 95, "cx": 392.69615384615383, "cy": 814.2107142857143, "area": 3640.0, "aspect_ratio": 5.905263157894737, "solidity": 0.11672839803100998, "extent": 0.06829908997091659}], "wine_id": "de20bc00db7971b6", "is_new_wine": True, "similar_wine": None}
# (Optional) Drop the nested copy to keep things lighter—it's ignored anyway.
blobdata2.pop("similar_wine", None)

# Wrap them as "records" for the API:
record1 = {"BlobData": blobdata1}
record2 = {"BlobData": blobdata2}

# Run the test (tune thresholds if you want)
similar, info = isBlobDataSimilar(
    record1, record2,
    threshold=0.55,        # final decision cutoff on the 0..1 score
    pair_threshold=0.22,   # per-pair gating cost (lower = stricter)
    return_details=True
)

print("similar?", similar)
print(info)


